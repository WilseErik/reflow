// =============================================================================
// Include statements
// =============================================================================
#include "fixed_point.h"

#include <stdint.h>
#include <stdbool.h>

// =============================================================================
// Private type definitions
// =============================================================================

// =============================================================================
// Global variables
// =============================================================================

// =============================================================================
// Private constants
// =============================================================================

// =============================================================================
// Private variables
// =============================================================================

// =============================================================================
// Private function declarations
// =============================================================================

// =============================================================================
// Public function definitions
// =============================================================================

//
// Algorithm from:
// C. S. Turner, "A Fast Binary Logarithm Algorithm",
// IEEE Signal Processing Mag., pp. 124,140, Sep. 2010.
// http://www.claysturner.com/dsp/BinaryLogarithm.pdf
//
// Implementation inspired by https://github.com/dmoulding/log2fix
//
q16_16_t q16_16_log(q16_16_t x)
{
    q16_16_t y = 0;
    int64_t z;
    int32_t b = Q16_16_T_ONE >> 1;
    uint8_t i;

    if (x <= 0)
    {
        return Q16_16_MIN;
    }

    //
    // Normalize x to [1, 2)
    //
    while (x >= Q16_16_T_ONE << 1)
    {
        x = x >> 1;
        y += Q16_16_T_ONE;
    }

    while (x < Q16_16_T_ONE)
    {
        x = x << 1;
        y -= Q16_16_T_ONE;
    }

    z = x;

    for (i = 0; i < 16; i++)
    {
        z = z * z >> 16;

        if (z >= Q16_16_T_ONE << 2)
        {
            z >>= 1;
            y += b;
        }
        
        b >>= 1;
    }

    return y;
}

// =============================================================================
// Private function definitions
// =============================================================================


